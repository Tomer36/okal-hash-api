<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>דוחות</title>
    <style>
      :root {
        color-scheme: light;
      }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, sans-serif;
        background: #f6f1ea;
        color: #222;
      }
      .wrap {
        min-height: 100vh;
        max-width: none;
        margin: 0;
        padding: 24px;
        background: #fffaf4;
        border: 0;
        border-radius: 0;
        box-shadow: none;
      }
      h1 {
        margin: 0 0 16px;
        font-size: 24px;
      }
      label {
        display: block;
        margin: 12px 0 6px;
        font-weight: 600;
      }
      input,
      select,
      button,
      textarea {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        border: 1px solid #d8cdbb;
        border-radius: 8px;
        background: #fff;
        box-sizing: border-box;
      }
      button {
        margin-top: 16px;
        background: #0057b7;
        color: #fff;
        border: none;
        cursor: pointer;
        font-weight: 600;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .hint {
        margin-top: 6px;
        font-size: 12px;
        color: #6a5b48;
      }
      .status {
        margin-top: 12px;
        color: #7a5b2f;
        min-height: 20px;
      }
      pre {
        margin-top: 16px;
        padding: 12px;
        background: #f2efe9;
        border: 1px solid #e2d7c5;
        border-radius: 8px;
        overflow: auto;
      }
      .table-wrap {
        margin-top: 16px;
        overflow: auto;
        border: 1px solid #e2d7c5;
        border-radius: 8px;
        background: #fff;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        padding: 8px 10px;
        border-bottom: 1px solid #eee2d3;
        text-align: right;
        vertical-align: top;
      }
      td.num {
        direction: ltr;
        text-align: right;
        unicode-bidi: plaintext;
      }
      th {
        background: #f6efe6;
        font-weight: 700;
      }
      tbody tr:nth-child(even) {
        background: #faf6f0;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>דוחות</h1>

      <label for="reportType">בחר דוח</label>
      <select id="reportType"></select>

      <div id="clientNumberGroup">
        <label for="clientNumber">מספר לקוח</label>
        <input id="clientNumber" type="text" placeholder="לדוגמה: 12345" />
        <div class="hint" id="clientHint"></div>
      </div>

      <div id="dateRangeGroup">
        <label for="dateFrom">מתאריך</label>
        <input id="dateFrom" type="date" />
        <label for="dateTo">עד תאריך</label>
        <input id="dateTo" type="date" />
        <div class="hint">אופציונלי: לשימוש בדוחות עם טווח תאריכים.</div>
      </div>

      <div id="invoiceNumberGroup">
        <label for="invoiceNumber">מספר חשבונית</label>
        <input id="invoiceNumber" type="text" inputmode="numeric" />
        <div class="hint">נדרש לדוח 200.</div>
      </div>

      <button id="runBtn">הצג דוח</button>
      <div class="status" id="status"></div>
      <div id="outputTableWrap" class="table-wrap" style="display: none">
        <table id="outputTable"></table>
      </div>
      <pre id="output">{}</pre>
    </div>

    <script>
      const reportCatalog = [
        { id: "174", name: "API פקודות יומן", needsClient: false },
        { id: "175", name: "API דוח אובליגו לקוחות תאמר", needsClient: false },
        { id: "176", name: "אינדקס אנשי קשר ולקוחות", needsClient: false },
        { id: "177", name: "API תעודות משלוח פתוחות לקוחות", needsClient: true },
        { id: "180", name: "API כרטסת", needsClient: true },
        { id: "181", name: "API דוח אובליגו לקוח בודד תאמר", needsClient: true },
        { id: "182", name: "דוח חשבוניות יומי עם יתרת חשבון מרואן", needsClient: false },
        {
          id: "183",
          name: 'דו"ח תעודות לא מתואמת-פתוחות לקוח בודד',
          needsClient: true,
        },
        { id: "184", name: "API אינדקס לקוחות לקוח בודד", needsClient: true },
        { id: "185", name: "אינדקס אנשי קשר ולקוחות לקוח בודד", needsClient: true },        { id: "187", name: "API תנועות שיקים דחויים", needsClient: true },
        { id: "188", name: "תעודות משלוח פתוחות לפי פריטים", needsClient: true },
        { id: "189", name: "הזמנות פתוחות וסגורות לפי פריטים", needsClient: true },
        { id: "198", name: "API אינדקס לקוחות", needsClient: false },
        { id: "200", name: "העתק חשבונית לפי מס חשבונית", needsClient: false },
        { id: "201", name: "לקוחות עם יתרה 0 עם אובליגו", needsClient: false },
      ];

      const dateRangeReports = new Set(["175", "181", "182", "198"]);
      const invoiceReports = new Set(["200"]);
      const clientNumberInput = document.getElementById("clientNumber");
      const clientHint = document.getElementById("clientHint");
      const clientGroup = document.getElementById("clientNumberGroup");
      const dateRangeGroup = document.getElementById("dateRangeGroup");
      const dateFromInput = document.getElementById("dateFrom");
      const dateToInput = document.getElementById("dateTo");
      const invoiceNumberGroup = document.getElementById("invoiceNumberGroup");
      const invoiceNumberInput = document.getElementById("invoiceNumber");
      const reportTypeSelect = document.getElementById("reportType");
      const runBtn = document.getElementById("runBtn");
      const statusEl = document.getElementById("status");
      const outputEl = document.getElementById("output");
      const outputTable = document.getElementById("outputTable");
      const outputTableWrap = document.getElementById("outputTableWrap");

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function formatDateForReport(value) {
        if (!value) {
          return "";
        }
        const [year, month, day] = value.split("-");
        if (!year || !month || !day) {
          return "";
        }
        return `${month}/${day}/${year}`;
      }

      const US_DATE_RE = /^(\d{2})\/(\d{2})\/(\d{4})$/;

      function formatDateForDisplay(value) {
        const match = US_DATE_RE.exec(value);
        if (!match) {
          return value;
        }
        const [, month, day, year] = match;
        return `${day}/${month}/${year}`;
      }

      function normalizeDisplayData(value) {
        if (Array.isArray(value)) {
          return value.map(normalizeDisplayData);
        }
        if (value && typeof value === "object") {
          return Object.fromEntries(
            Object.entries(value).map(([key, val]) => [
              key,
              normalizeDisplayData(val),
            ])
          );
        }
        if (typeof value === "string") {
          return formatDateForDisplay(value);
        }
        return value;
      }

      function findFirstArray(value) {
        if (Array.isArray(value)) {
          return value;
        }
        if (value && typeof value === "object") {
          for (const key of Object.keys(value)) {
            const found = findFirstArray(value[key]);
            if (found) {
              return found;
            }
          }
        }
        return null;
      }

      function renderTableFromArray(arr) {
        outputTable.innerHTML = "";
        if (!Array.isArray(arr) || arr.length === 0) {
          return false;
        }

        const isObjectArray = arr.some(
          (item) => item && typeof item === "object" && !Array.isArray(item)
        );
        const columns = isObjectArray
          ? Array.from(
              arr.reduce((set, item) => {
                if (item && typeof item === "object") {
                  Object.keys(item).forEach((key) => set.add(key));
                }
                return set;
              }, new Set())
            )
          : ["value"];

        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");
        columns.forEach((col) => {
          const th = document.createElement("th");
          th.textContent = col;
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);

        const tbody = document.createElement("tbody");
        arr.forEach((item) => {
          const row = document.createElement("tr");
          columns.forEach((col) => {
            const td = document.createElement("td");
            const value = isObjectArray ? item?.[col] : item;
            if (
              typeof value === "number" ||
              (typeof value === "string" &&
                value.trim() !== "" &&
                !Number.isNaN(Number(value)))
            ) {
              td.classList.add("num");
            }
            td.textContent =
              value === null || value === undefined ? "" : String(value);
            row.appendChild(td);
          });
          tbody.appendChild(row);
        });

        outputTable.appendChild(thead);
        outputTable.appendChild(tbody);
        return true;
      }

      function renderOutput(data) {
        const displayData = normalizeDisplayData(data);
        const firstArray = findFirstArray(displayData);
        const tableRendered = renderTableFromArray(firstArray);
        if (tableRendered) {
          outputTableWrap.style.display = "";
          outputEl.style.display = "none";
          outputEl.textContent = "";
          return;
        }
        outputTableWrap.style.display = "none";
        outputEl.style.display = "";
        outputEl.textContent = JSON.stringify(displayData, null, 2);
      }

      function renderReportTypes() {
        reportTypeSelect.innerHTML = "";
        reportCatalog.forEach((item) => {
          const option = document.createElement("option");
          option.value = item.id;
          option.textContent = `${item.id} - ${item.name}`;
          reportTypeSelect.appendChild(option);
        });
      }

      function updateClientSection(reportId) {
        const report = reportCatalog.find((item) => item.id === reportId);
        if (!report) {
          clientGroup.style.display = "";
          clientHint.textContent = "יתכן שצריך מספר לקוח לדוח זה.";
          return;
        }
        if (report.needsClient) {
          clientGroup.style.display = "";
          clientHint.textContent = "דוח זה דורש מספר לקוח.";
        } else {
          clientGroup.style.display = "none";
          clientNumberInput.value = "";
          clientHint.textContent = "";
        }
      }

      function updateDateRangeSection(reportId) {
        const needsDateRange = dateRangeReports.has(reportId);
        if (needsDateRange) {
          dateRangeGroup.style.display = "";
          return;
        }
        dateRangeGroup.style.display = "none";
        dateFromInput.value = "";
        dateToInput.value = "";
      }

      function updateInvoiceSection(reportId) {
        const needsInvoice = invoiceReports.has(reportId);
        if (needsInvoice) {
          invoiceNumberGroup.style.display = "";
          return;
        }
        invoiceNumberGroup.style.display = "none";
        invoiceNumberInput.value = "";
      }

      async function runReport() {
        const baseUrl =
          window.location.origin && window.location.origin !== "null"
            ? window.location.origin
            : "http://localhost:6001";
        const clientNumber = clientNumberInput.value.trim();
        const reportType = reportTypeSelect.value.trim();
        const report = reportCatalog.find((item) => item.id === reportType);

        if (!reportType) {
          setStatus("אנא בחר דוח.");
          return;
        }
        if (report?.needsClient && !clientNumber) {
          setStatus("אנא הזן מספר לקוח.");
          return;
        }
        const invoiceNumber = invoiceNumberInput.value.trim();
        if (invoiceReports.has(reportType) && !invoiceNumber) {
          setStatus("Invoice number is required for this report.");
          return;
        }

        setStatus("טוען...");
        outputEl.textContent = "{}";
        outputEl.style.display = "";
        outputTableWrap.style.display = "none";
        runBtn.disabled = true;

        try {
          const payload = {};
          if (clientNumber) {
            payload.clientNumber = clientNumber;
          }
          const dateFrom = formatDateForReport(dateFromInput.value);
          const dateTo = formatDateForReport(dateToInput.value);
          if (dateFrom) {
            payload.dateFrom = dateFrom;
          }
          if (dateTo) {
            payload.dateTo = dateTo;
          }
          if (invoiceNumber) {
            payload.invoiceNumber = invoiceNumber;
          }
          const response = await fetch(`${baseUrl}/reports/${reportType}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data?.error || "שגיאת שרת");
          }

          renderOutput(data);
          setStatus("הדוח נטען בהצלחה.");
        } catch (err) {
          setStatus(`שגיאה: ${err.message}`);
        } finally {
          runBtn.disabled = false;
        }
      }

      renderReportTypes();
      updateClientSection(reportTypeSelect.value);
      updateDateRangeSection(reportTypeSelect.value);
      updateInvoiceSection(reportTypeSelect.value);
      reportTypeSelect.addEventListener("change", (event) => {
        const selectedReport = event.target.value.trim();
        updateClientSection(selectedReport);
        updateDateRangeSection(selectedReport);
        updateInvoiceSection(selectedReport);
      });
      runBtn.addEventListener("click", runReport);
    </script>
  </body>
</html>
